<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>General Store - Magma</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Theme Color Variable --- */
        :root {
            --primary-color: #1a2f3d;
            --primary-color-darker: #12212b;
            --badge-color: #ff5252; /* Color for badges */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Helvetica, Arial, sans-serif;
            touch-action: manipulation;
        }

        html, body {
            overflow-x: hidden;
            max-width: 100%;
            touch-action: pan-y;
            background-color: #f8f9fa;
            color: #333;
        }

        .container {
            max-width: 100%;
            padding-top: 70px; /* Space for fixed header */
            padding-bottom: 90px; /* Extra space at bottom for FAB visibility */
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 100;
            height: 65px;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        /* Back Button / Logo Container Style */
        .back-btn {
            background: none; border: none; margin-right: 15px; color: var(--primary-color);
            cursor: pointer; padding: 0; text-decoration: none; display: flex;
            align-items: center; justify-content: center; width: 50px; height: 50px;
        }

        .header-logo {
            width: 50px; height: 50px; border-radius: 50%; /* Circle */
            object-fit: cover; display: block; background-color: #eee; /* Fallback bg */
        }

        .back-btn:hover { opacity: 0.8; }

        .header-title {
            font-size: 18px; font-weight: 600; color: #212b36;
        }

        .header-right {
            display: flex; align-items: center; gap: 25px; /* Increased gap slightly */
        }

        .header-icon {
             position: relative; /* Needed for badge positioning */
             font-size: 22px; color: #333; cursor: pointer;
             padding: 5px; /* Add padding for easier tapping */
             transition: transform 0.2s ease-in-out; /* Animation */
        }
        /* Cart icon specific color */
        .header-icon .fa-shopping-cart { color: var(--primary-color); }

        /* Cart icon hover/active animation */
        .header-icon.cart-icon-container:hover {
            transform: scale(1.1);
        }
         .header-icon.cart-icon-container:active {
             transform: scale(1.05);
         }


        /* --- Badge Styling (Common for Notification & Cart) --- */
        .badge {
            position: absolute;
            top: -3px; /* Adjusted position slightly */
            right: -3px; /* Adjusted position slightly */
            background-color: var(--badge-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex; /* Use flex to center content */
            justify-content: center;
            align-items: center;
            font-size: 10px;
            font-weight: bold;
            line-height: 1; /* Ensure text fits vertically */
            border: 1px solid white; /* Optional border */
            pointer-events: none; /* Prevent badge from interfering with clicks */
        }
        /* Hide badges by default */
        .notification-badge, .cart-badge {
            display: none;
        }
        /* Show badge if it has content (will be controlled by JS) */
        .badge.visible {
            display: flex;
        }
        /* --- End Badge Styling --- */


        /* Search Bar */
        .search-container {
            padding: 15px; background-color: #fff; margin-bottom: 10px;
        }
        .search-bar {
            display: flex; align-items: center; background-color: #f1f3f4; border-radius: 25px; padding: 8px 15px;
        }
        .search-bar i { color: #5f6368; margin-right: 10px; }
        .search-bar input { flex: 1; border: none; background: transparent; outline: none; font-size: 14px; }
        .search-bar input:focus { box-shadow: 0 0 0 1px var(--primary-color); }

        /* Categories */
        .categories {
            display: flex; overflow-x: auto; padding: 10px 15px; background-color: #fff; margin-bottom: 15px; scrollbar-width: none;
        }
        .categories::-webkit-scrollbar { display: none; }
        .category {
            flex: 0 0 auto; padding: 8px 15px; margin-right: 10px; background-color: #f1f3f4; border-radius: 20px; font-size: 13px; white-space: nowrap; cursor: pointer; transition: background-color 0.3s, color 0.3s; border: 1px solid transparent;
        }
        .category.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* Products Grid & Card */
        .products-container { padding: 10px; }
        .products-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 0 5px; align-items: stretch;
        }
        .product-card {
            background-color: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); transition: transform 0.3s, box-shadow 0.3s; display: flex; flex-direction: column; height: 100%;
        }
        .product-card:active { transform: scale(0.98); }
        .product-image {
            width: 100%; height: 150px; overflow: hidden; position: relative; background-color: #eee; flex-shrink: 0;
        }
        .product-image img { width: 100%; height: 100%; object-fit: cover; }
        .discount-badge {
            position: absolute; top: 10px; right: 10px; background-color: var(--badge-color); color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;
        }
        .product-details {
            padding: 12px; display: flex; flex-direction: column; flex-grow: 1;
        }
        .product-title {
            font-size: 14px; font-weight: 600; margin-bottom: 5px; color: #333; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 42px; line-height: 1.5;
        }
        .product-vendor {
            font-size: 12px; color: #666; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .product-price {
            display: flex; align-items: center; margin-bottom: 8px;
        }
        .current-price { font-size: 16px; font-weight: 700; color: #333; }
        .original-price { font-size: 12px; color: #999; text-decoration: line-through; margin-left: 8px; }
        .product-tags {
            display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; height: 22px; overflow: hidden; margin-bottom: 10px;
        }
        .product-tag { background-color: #f1f3f4; padding: 2px 8px; border-radius: 10px; font-size: 10px; color: #666; }
        .add-to-cart {
            background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 8px 0; width: 100%; font-size: 13px; font-weight: 500; cursor: pointer; transition: background-color 0.3s; margin-top: auto;
        }
        .add-to-cart:active, .add-to-cart:hover { background-color: var(--primary-color-darker); }

        /* Loading, Error, Empty States */
        .loading {
            display: flex; justify-content: center; align-items: center; height: 200px; width: 100%;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); border-radius: 50%; border-top: 4px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message {
            text-align: center; padding: 20px; color: var(--badge-color); font-weight: bold;
        }
        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; text-align: center; min-height: 200px;
        }
        .empty-state i { font-size: 50px; color: #ccc; margin-bottom: 15px; }
        .empty-state h3 { font-size: 18px; color: #333; margin-bottom: 10px; }
        .empty-state p { font-size: 14px; color: #666; margin-bottom: 20px; }

        /* FAB */
        .fab {
            position: fixed; bottom: 35px; right: 20px; width: 55px; height: 55px; background-color: var(--primary-color); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; text-decoration: none; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); z-index: 999; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.2s;
        }
        .fab:hover { background-color: var(--primary-color-darker); transform: scale(1.05); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3); }

    </style>
    <script>
        // Firebase configuration (Using the specific config provided by user)
        const firebaseConfig = {
          apiKey: "AIzaSyDwldURmtljNpORmpGRacwXriPmQZjF6j8",
          authDomain: "daisy-n7g20a.firebaseapp.com",
          databaseURL: "https://daisy-n7g20a-default-rtdb.firebaseio.com",
          projectId: "daisy-n7g20a",
          storageBucket: "daisy-n7g20a.appspot.com",
          messagingSenderId: "225362605902",
          appId: "1:225362605902:web:d6672119cd68e7ffc3d01f"
        };

        // Prevent zoom scripts
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('touchstart', function(event) {
                if (event.touches.length > 1) { event.preventDefault(); }
            }, { passive: false });
            document.addEventListener('touchmove', function(event) {
                if (event.touches.length > 1) { event.preventDefault(); }
            }, { passive: false });
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = Date.now(); if (now - lastTouchEnd <= 300) { event.preventDefault(); } lastTouchEnd = now;
            }, { passive: false });

            // Initialize Firebase and Start Logic AFTER DOM is ready
            initializeFirebaseAndApp();
        });
    </script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <a href="home.html" class="back-btn">
                 <!-- **** Unsplash Placeholder Logo **** -->
                 <!-- Using a direct link to a small, cropped Unsplash image -->
                <img src="https://images.unsplash.com/photo-1611162617213-7d7a39e9b1d7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=50&h=50&q=80"
                     alt="Logo" class="header-logo"
                     onerror="this.style.backgroundColor='#ddd'; console.error('Logo image failed to load')">
            </a>
            <div class="header-title">Kabarro</div> <!-- Updated Title -->
        </div>
        <div class="header-right">
            <!-- Notification Icon -->
            <div class="notification header-icon">
                <i class="fas fa-bell"></i>
                 <!-- Notification badge (hidden by default, no static count) -->
                <span class="badge notification-badge" id="notificationCountBadge"></span>
                 <!-- Note: Actual notification fetching/display logic is not included in this version -->
            </div>
             <!-- Cart Icon -->
             <div class="header-icon cart-icon-container" id="cartIconContainer">
                 <i class="fas fa-shopping-cart"></i>
                 <!-- Cart Item Count Badge -->
                 <span class="badge cart-badge" id="cartItemCountBadge">0</span>
             </div>
        </div>
    </div>

    <div class="container">
        <!-- Search Bar -->
        <div class="search-container">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search products..." id="searchInput">
            </div>
        </div>

        <!-- Categories -->
        <div class="categories">
            <div class="category active" data-category="all">All</div>
            <div class="category" data-category="Groceries">Groceries</div>
            <div class="category" data-category="Meat">Meat</div>
            <div class="category" data-category="Drinks">Drinks</div>
            <div class="category" data-category="Snacks">Snacks</div>
            <div class="category" data-category="Household">Household</div>
            <div class="category" data-category="Personal Care">Personal Care</div>
            <div class="category" data-category="Frozen">Frozen Foods</div>
            <div class="category" data-category="Digital Products">Digital Products</div>
            <div class="category" data-category="Electronics">Electronics</div>
            <div class="category" data-category="Clothing">Clothing</div>
            <div class="category" data-category="Bakery">Bakery</div>
        </div>

        <!-- Products Grid Container -->
        <div class="products-container">
            <div class="loading" id="loadingIndicator">
                <div class="loading-spinner"></div>
            </div>
            <div class="error-message" id="errorMessage" style="display: none;"></div>
            <div class="products-grid" id="productsGrid" style="display: none;"></div>
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="fas fa-shopping-basket"></i>
                <h3>No Products Found</h3>
                <p>There are currently no products matching your search or filter.</p>
            </div>
        </div>

    </div> <!-- End .container -->

    <!-- Floating Action Button -->
    <a href="add-products.html" class="fab">
        <i class="fas fa-plus"></i>
    </a>

    <script>
        // --- Firebase Initialization and App Logic ---
        let auth, db, productsCollectionRef;
        let allProducts = [];
        let currentCategory = 'all';
        let listenersInitialized = false;
        let cartItemCount = 0; // Simple in-memory cart counter

        // --- DOM Elements ---
        const productsGrid = document.getElementById('productsGrid');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const emptyState = document.getElementById('emptyState');
        const searchInput = document.getElementById('searchInput');
        const categories = document.querySelectorAll('.category');
        const cartIconContainer = document.getElementById('cartIconContainer');
        const cartItemCountBadge = document.getElementById('cartItemCountBadge');
        const notificationCountBadge = document.getElementById('notificationCountBadge'); // Reference to notification badge

        // --- Initialize Firebase and Auth ---
        function initializeFirebaseAndApp() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig); // Using USER-PROVIDED config
                    console.log("Firebase initialized successfully with provided config.");
                } else {
                     firebase.app();
                     console.log("Firebase already initialized.");
                }
                auth = firebase.auth();
                db = firebase.firestore();
                productsCollectionRef = db.collection("kabarroph_products");

                // --- Handle Authentication State ---
                auth.onAuthStateChanged(user => {
                    if (user) {
                        console.log("Auth State Changed: User is signed in. UID:", user.uid, "Anonymous:", user.isAnonymous);
                        if (allProducts.length === 0 && errorMessage.style.display === 'none') {
                            initializeProductFetching();
                        } else {
                            hideLoading();
                            if (productsGrid.children.length > 0) { productsGrid.style.display = 'grid'; }
                            else if (errorMessage.style.display === 'none') { showEmptyState(); }
                        }
                        // ** Placeholder: Load actual cart data here if persistent **
                        updateCartBadge(); // Initialize badge (shows 0 if cartItemCount is 0)
                    } else {
                        console.log("Auth State Changed: No user signed in. Attempting anonymous sign-in...");
                        allProducts = []; productsGrid.innerHTML = ''; listenersInitialized = false; cartItemCount = 0;
                        updateCartBadge(); // Hide cart badge on logout
                        signInAnonymously();
                    }
                });

            } catch (error) {
                console.error("CRITICAL: Firebase initialization failed:", error);
                showError("Application setup failed. Check console.");
            }
        }

        // --- Anonymous Sign-In ---
        function signInAnonymously() {
            showLoading();
            auth.signInAnonymously()
                .then(() => { console.log("Anonymous sign-in successful."); })
                .catch((error) => { console.error("--- ANONYMOUS SIGN-IN FAILED ---", error); showError(`Authentication failed: ${error.message}. (Code: ${error.code})`); });
        }

        // --- Product Fetching ---
        async function initializeProductFetching() {
            if (!auth.currentUser) { console.warn("Attempted to fetch before auth."); showLoading(); return; }
            console.log("Fetching products..."); showLoading();
            allProducts = await fetchProducts();
             if (errorMessage.style.display !== 'block') { renderProducts(allProducts); setupEventListeners(); }
             else { hideLoading(); console.log("Skipping render due to fetch error."); }
        }

        // --- Fetch Products from Firestore ---
        async function fetchProducts() {
            if (!productsCollectionRef) { showError("Database connection error."); return []; }
            console.log(`Querying Firestore: ${productsCollectionRef.path}`);
            try {
                const snapshot = await productsCollectionRef.where("Status", "==", "active").get(); const productsArray = [];
                if (snapshot.empty) { console.log("No active products found."); }
                else { snapshot.forEach(doc => { productsArray.push({ id: doc.id, ...doc.data() }); }); console.log(`Fetched ${productsArray.length} products.`); }
                return productsArray;
            } catch (error) { console.error("Error fetching products:", error); if (error.code === 'permission-denied') { showError(`Firestore permission denied.`); } else { showError(`Failed to load products.`); } return []; }
        }


        // --- Setup Event Listeners ---
        function setupEventListeners() {
            if (listenersInitialized) { return; } // Prevent adding multiple listeners
            console.log("Setting up event listeners...");

            searchInput.addEventListener('input', debouncedApplyFilters);

            categories.forEach(category => {
                category.addEventListener('click', () => {
                    if (category.classList.contains('active')) return;
                    categories.forEach(c => c.classList.remove('active'));
                    category.classList.add('active');
                    currentCategory = category.dataset.category;
                    applyFilters();
                });
            });

            // Add to Cart Clicks
            productsGrid.addEventListener('click', (event) => {
                 if (event.target.classList.contains('add-to-cart')) {
                     const button = event.target;
                     const productId = button.dataset.productId;
                     if (!productId) { console.error("Add to Cart button missing product ID."); return; }
                     handleAddToCart(productId, button);
                 }
             });

             // Cart Icon Click for Navigation
            cartIconContainer.addEventListener('click', () => {
                console.log("Cart icon clicked, navigating to cart.html");
                window.location.href = 'cart.html'; // Navigate to cart page
            });

            listenersInitialized = true;
            console.log("Event listeners setup complete.");
            updateCartBadge(); // Update badge once listeners are ready
        }

        // --- Add to Cart Handler ---
        function handleAddToCart(productId, buttonElement) {
            console.log(`Adding product ID to cart (simulated): ${productId}`);
            cartItemCount++; // Increment in-memory counter
            updateCartBadge(); // Update the visual badge in header

            // --- Visual Feedback for Button ---
            buttonElement.textContent = 'Adding...';
            buttonElement.disabled = true;
            setTimeout(() => {
                 buttonElement.textContent = 'Added!';
                 setTimeout(() => {
                    buttonElement.textContent = 'Add to Cart';
                    buttonElement.disabled = false;
                 }, 1000); // Show "Added!" for 1 second
            }, 300);
            // **Note:** For a real cart, save `cartItemCount` or cart details to Firestore/localStorage here.
        }

        // --- Update Cart Badge UI ---
        function updateCartBadge() {
            if (!cartItemCountBadge) return; // Safety check

            if (cartItemCount > 0) {
                cartItemCountBadge.textContent = cartItemCount > 9 ? '9+' : cartItemCount.toString();
                cartItemCountBadge.classList.add('visible'); // Show badge
            } else {
                cartItemCountBadge.textContent = '0'; // Reset text
                cartItemCountBadge.classList.remove('visible'); // Hide badge
            }
             // Ensure notification badge remains hidden (as no mock data)
             if (notificationCountBadge) {
                 notificationCountBadge.classList.remove('visible');
             }
        }


        // --- Render Products ---
        function renderProducts(products) {
            productsGrid.innerHTML = '';
            if (!Array.isArray(products)) { console.error("RenderProducts invalid data:", products); showEmptyState("Error", "Invalid product data."); return; }
            if (products.length === 0) { const searchTerm = searchInput.value.trim(); if (currentCategory === 'all' && !searchTerm) { showEmptyState("No Products Available"); } else { showEmptyState("No Products Found", "No products match."); } return; }
            console.log(`Rendering ${products.length} products...`);
            products.sort((a, b) => (a.Title || a.name || '').localeCompare(b.Title || b.name || ''));
            const fragment = document.createDocumentFragment();
            products.forEach(product => {
                const currentPrice = product['Variant Price'] ?? product.price ?? null; const comparePrice = product['Variant Compare At Price'] ?? product.compare_at_price ?? null; const imageSrc = product['Image Src'] ?? (Array.isArray(product.imageUrls) && product.imageUrls[0]) ?? 'assets/images/placeholder.svg'; const title = product.Title ?? product.name ?? 'Unnamed Product'; const vendor = product.Vendor ?? 'General Store'; let tags = product.Tags ?? []; if (typeof tags === 'string') { tags = tags.split(',').map(tag => tag.trim()).filter(tag => tag); } else if (!Array.isArray(tags)) { tags = []; }
                const discountPercentage = calculateDiscountPercentage(currentPrice, comparePrice); const currentPriceFormatted = formatPrice(currentPrice); const originalPriceFormatted = formatPrice(comparePrice);
                const productCard = document.createElement('div'); productCard.className = 'product-card';
                productCard.innerHTML = `
                    <div class="product-image"> <img src="${imageSrc}" alt="${title}" loading="lazy" onerror="this.onerror=null; this.src='assets/images/placeholder.svg'; console.warn('Image failed:', this.src)"> ${discountPercentage ? `<div class="discount-badge">-${discountPercentage}%</div>` : ''} </div>
                    <div class="product-details"> <div class="product-title">${title}</div> <div class="product-vendor">${vendor}</div> <div class="product-price"> <div class="current-price">${currentPriceFormatted}</div> ${originalPriceFormatted && discountPercentage ? `<div class="original-price">${originalPriceFormatted}</div>` : ''} </div> <div class="product-tags"> ${tags.slice(0, 2).map(tag => `<div class="product-tag">${tag}</div>`).join('')} </div> <button class="add-to-cart" data-product-id="${product.id || ''}">Add to Cart</button> </div>`;
                fragment.appendChild(productCard);
            });
            productsGrid.appendChild(fragment);
            hideLoading(); productsGrid.style.display = 'grid'; emptyState.style.display = 'none'; errorMessage.style.display = 'none';
            console.log("Rendering complete.");
        }

        // --- Helper & Utility Functions ---
        function formatPrice(price) { if (price === null || price === undefined || price === '') return ''; const number = parseFloat(price); if (isNaN(number)) return ''; return `â‚±${number.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`; }
        function calculateDiscountPercentage(currentPrice, originalPrice) { const current = parseFloat(currentPrice); const original = parseFloat(originalPrice); if (isNaN(current) || isNaN(original) || original <= 0 || original <= current) return null; const discount = Math.round(((original - current) / original) * 100); return discount > 0 ? discount : null; }
        function filterProductsByCategory(products, category) { if (category === 'all') return products; const lowerCaseCategory = category.toLowerCase(); return products.filter(product => { const type = (product.Type ?? product.category ?? '').toLowerCase(); const productCategory = (product['Product Category'] ?? '').toLowerCase(); let tagsMatch = false; if (Array.isArray(product.Tags)) { tagsMatch = product.Tags.some(tag => tag.toLowerCase().includes(lowerCaseCategory)); } else if (typeof product.Tags === 'string') { tagsMatch = product.Tags.toLowerCase().includes(lowerCaseCategory); } return type.includes(lowerCaseCategory) || productCategory.includes(lowerCaseCategory) || tagsMatch; }); }
        function filterProductsBySearch(products, searchTerm) { if (!searchTerm) return products; const lowerCaseSearchTerm = searchTerm.toLowerCase(); return products.filter(product => { const title = (product.Title ?? product.name ?? '').toLowerCase(); const vendor = (product.Vendor ?? '').toLowerCase(); const description = (product['Body (HTML)'] ?? product.description ?? '').toLowerCase(); const type = (product.Type ?? product.category ?? '').toLowerCase(); let tagsMatch = false; if (Array.isArray(product.Tags)) { tagsMatch = product.Tags.some(tag => tag.toLowerCase().includes(lowerCaseSearchTerm)); } else if (typeof product.Tags === 'string') { tagsMatch = product.Tags.toLowerCase().includes(lowerCaseSearchTerm); } return title.includes(lowerCaseSearchTerm) || vendor.includes(lowerCaseSearchTerm) || description.includes(lowerCaseSearchTerm) || type.includes(lowerCaseSearchTerm) || tagsMatch; }); }
        function showLoading() { loadingIndicator.style.display = 'flex'; productsGrid.style.display = 'none'; errorMessage.style.display = 'none'; emptyState.style.display = 'none'; }
        function hideLoading() { loadingIndicator.style.display = 'none'; }
        function showError(message = "An error occurred.") { hideLoading(); errorMessage.textContent = message; errorMessage.style.display = 'block'; productsGrid.style.display = 'none'; emptyState.style.display = 'none'; console.error("Error displayed:", message); }
        function showEmptyState(message = "No Products Found", subMessage = "There are currently no products matching.") { hideLoading(); emptyState.querySelector('h3').textContent = message; emptyState.querySelector('p').textContent = subMessage; emptyState.style.display = 'flex'; productsGrid.style.display = 'none'; errorMessage.style.display = 'none'; }
        let searchTimeout; function debouncedApplyFilters() { clearTimeout(searchTimeout); searchTimeout = setTimeout(applyFilters, 300); }
        function applyFilters() { const searchTerm = searchInput.value.trim(); console.log(`Applying filters - Cat: '${currentCategory}', Search: '${searchTerm}'`); showLoading(); setTimeout(() => { let filtered = filterProductsByCategory(allProducts, currentCategory); filtered = filterProductsBySearch(filtered, searchTerm); renderProducts(filtered); }, 10); }

    </script>
</body>
</html>
